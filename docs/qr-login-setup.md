# QR-коды для авторизации

## Описание

Система поддерживает генерацию QR-кодов для быстрой авторизации пользователей. Пользователь может отсканировать QR-код камерой телефона и автоматически войти в систему.

## Как это работает

1. **Генерация QR-кода**: Администратор генерирует QR-код для конкретного пользователя
2. **Magic Link**: QR-код содержит magic link, который создается через Supabase Auth
3. **Авторизация**: Пользователь сканирует QR-код, переходит по ссылке и автоматически авторизуется
4. **Безопасность**: Ссылки имеют ограниченное время жизни (15 минут) и одноразовые

## Использование

### Для администраторов

1. Перейдите в раздел "Мои сотрудники" (`/employees`)
2. Найдите нужного сотрудника и разверните его карточку
3. Нажмите кнопку "QR-код для входа"
4. В модальном окне отобразится QR-код для пользователя
5. Пользователь может отсканировать QR-код или получить прямую ссылку

### Для пользователей

1. Отсканируйте QR-код камерой телефона
2. Перейдите по открывшейся ссылке
3. Вы автоматически авторизуетесь в системе
4. Будете перенаправлены на главную страницу

## Технические детали

### Edge Function

- **Путь**: `/functions/v1/generate-qr-login`
- **Метод**: POST
- **Авторизация**: Требуется токен администратора/модератора
- **Параметры**: `{ email: string, redirectTo?: string }`

### Компоненты

- `UserQRLogin` - модальное окно с QR-кодом
- `AuthCallback` - страница обработки callback'а авторизации

### Безопасность

- Только администраторы и модераторы могут генерировать QR-коды
- Magic links имеют ограниченное время жизни
- Ссылки одноразовые (после использования становятся недействительными)
- Проверка прав доступа на уровне Edge Function

## Настройка

### Переменные окружения

Убедитесь, что в Supabase настроены следующие переменные:

- `SUPABASE_URL` - URL вашего Supabase проекта
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role ключ (только для Edge Function)
- `PUBLIC_APP_URL` - URL вашего приложения для redirect'ов

### Развертывание

Edge Function автоматически развертывается при выполнении:

```bash
npx supabase functions deploy generate-qr-login
```

## Ограничения

- QR-коды действительны 15 минут
- Ссылки одноразовые
- Требуется email для генерации QR-кода
- Только для пользователей с ролью администратора/модератора

## Устранение неполадок

### QR-код не генерируется

1. Проверьте права пользователя (должен быть администратор/модератор)
2. Убедитесь, что у сотрудника указан email
3. Проверьте логи Edge Function в Supabase Dashboard

### Авторизация не работает

1. Проверьте, что callback URL настроен в Supabase Auth
2. Убедитесь, что QR-код не истек (15 минут)
3. Проверьте, что ссылка не была использована ранее

### Ошибки в консоли

1. Проверьте переменные окружения
2. Убедитесь, что Edge Function развернута
3. Проверьте права доступа к Supabase

