# Инструкция по внедрению новых типов оценки

## Обзор изменений

Добавлены два новых типа оценки по аналогии с существующим "Решение кейсов":

1. **Защита проектов** - оценка презентации и защиты проектов по 3 критериям
2. **Диагностическая игра** - оценка управленческих компетенций по 4 критериям

## Что было создано

### Frontend компоненты

1. **ProjectDefenseModal.tsx** - модальное окно для оценки защиты проектов
2. **DiagnosticGameModal.tsx** - модальное окно для оценки компетенций
3. **ProjectDefenseCard.tsx** - карточка участника для защиты проектов
4. **DiagnosticGameCard.tsx** - карточка участника для диагностической игры
5. Обновлен **EvaluationSuccessModal.tsx** для поддержки новых типов оценки
6. Обновлен **ReservistEvaluationPage.tsx** с новыми табами и функциональностью

### Database схема

1. **create_project_defense_evaluations.sql** - таблица для оценок защиты проектов
2. **create_diagnostic_game_evaluations.sql** - таблица для оценок компетенций

## Применение миграций базы данных

### 1. Таблица защиты проектов

```bash
psql -h your-db-host -U your-username -d your-database -f create_project_defense_evaluations.sql
```

Или через Supabase Dashboard:
1. Перейдите в SQL Editor
2. Скопируйте содержимое файла `create_project_defense_evaluations.sql`
3. Выполните запрос

### 2. Таблица диагностической игры

```bash
psql -h your-db-host -U your-username -d your-database -f create_diagnostic_game_evaluations.sql
```

Или через Supabase Dashboard:
1. Перейдите в SQL Editor
2. Скопируйте содержимое файла `create_diagnostic_game_evaluations.sql`
3. Выполните запрос

## Структура новых таблиц

### project_defense_evaluations

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| exam_event_id | UUID | ID экзамена |
| reservist_id | UUID | ID участника |
| evaluator_id | UUID | ID эксперта |
| presentation_number | INTEGER | Номер выступления (1-10) |
| criteria_scores | JSONB | Оценки по критериям |
| comments | TEXT | Комментарии |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Критерии оценки (criteria_scores):
- `goal_achievement` - Степень достижения планируемой цели проекта
- `topic_development` - Степень проработки темы проекта  
- `document_quality` - Качество оформления документов проекта

### diagnostic_game_evaluations

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| exam_event_id | UUID | ID экзамена |
| reservist_id | UUID | ID участника |
| evaluator_id | UUID | ID эксперта |
| competency_scores | JSONB | Оценки по компетенциям |
| comments | TEXT | Комментарии |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата обновления |

#### Компетенции (competency_scores):
- `results_orientation` - Ориентация на результат
- `effective_communication` - Эффективная коммуникация
- `teamwork_skills` - Умение работать в команде
- `systemic_thinking` - Системное мышление

## Особенности реализации

### Система оценок
- **Защита проектов**: оценки от 1 до 5 с шагом 0.5 (1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5)
- **Диагностическая игра**: оценки от 1 до 5 с шагом 0.5 (с валидацией на уровне БД)

### Номер выступления
- У каждого участника есть номер выступления (1, 2, 3, 4, 5...)
- Автоматически присваивается по порядку участников
- Сохраняется в поле `presentation_number`

### Безопасность (RLS)
- Только эксперты могут создавать/изменять оценки
- Участники могут видеть только свои оценки
- Реализованы все необходимые политики безопасности

### UI/UX
- Современный дизайн в стиле существующих компонентов
- Карточки участников с индикаторами завершения
- Детальные модальные окна для каждого типа оценки
- Корпоративный зеленый цвет (#06A478) для иконок
- Адаптивный дизайн для мобильных устройств

## Тестирование

После применения миграций:

1. Войдите в систему как эксперт
2. Перейдите на страницу экзамена
3. Проверьте работу табов "Защита проекта" и "Диагностическая игра"
4. Протестируйте создание и сохранение оценок
5. Убедитесь, что валидация работает корректно

## Rollback (откат изменений)

Если необходимо откатить изменения:

```sql
-- Удаление таблиц
DROP TABLE IF EXISTS public.diagnostic_game_evaluations;
DROP TABLE IF EXISTS public.project_defense_evaluations;

-- Удаление функций
DROP FUNCTION IF EXISTS validate_competency_scores(JSONB);
DROP FUNCTION IF EXISTS update_diagnostic_game_evaluations_updated_at();
DROP FUNCTION IF EXISTS update_project_defense_evaluations_updated_at();
```

## Поддержка

При возникновении проблем:
1. Проверьте логи браузера на наличие ошибок
2. Убедитесь, что миграции применены корректно
3. Проверьте права доступа пользователя в таблице `users`
4. Проверьте корректность значений в поле `role` (должно быть 'expert', 'trainer', 'moderator', или 'administrator')
